{"version":3,"file":"index.js","sources":["../src/emoji-picker.ts"],"sourcesContent":["import { Node } from \"@tiptap/core\";\nimport Heading from \"@tiptap/extension-heading\";\nimport { Plugin, PluginKey, TextSelection } from \"prosemirror-state\";\nimport { v4 as uuidv4 } from \"uuid\";\n\nexport interface AnchorHeadingOptions {\n  levels?: number[];\n  onUpdate?: (anchors: string[]) => void;\n}\n\ndeclare module \"@tiptap/core\" {\n  interface Commands<ReturnType> {\n    anchorHeading: {\n      /**\n       * Focus on a heading by its anchor.\n       */\n      focusAnchor: (anchor: string) => ReturnType;\n    };\n  }\n}\n\nexport const AnchorHeading = Heading.extend<AnchorHeadingOptions>({\n  addOptions() {\n    return {\n      ...this.parent?.(),\n      onUpdate: () => {},\n    };\n  },\n\n  addAttributes() {\n    return {\n      ...this.parent?.(),\n      anchor: {\n        default: null,\n        parseHTML: (element) => element.getAttribute(\"data-anchor\"),\n        renderHTML: (attributes) => {\n          if (!attributes.anchor) {\n            return {};\n          }\n          return {\n            \"data-anchor\": attributes.anchor,\n          };\n        },\n      },\n    };\n  },\n\n  addCommands() {\n    return {\n      ...this.parent?.(),\n      focusAnchor:\n        (anchor) =>\n        ({ state, dispatch, view }) => {\n          const { doc } = state;\n          let pos: number | null = null;\n          doc.descendants((node, position) => {\n            if (node.type.name === this.name && node.attrs.anchor === anchor) {\n              pos = position + 1;\n              return false; // Stop iteration\n            }\n          });\n          if (pos !== null) {\n            view.focus();\n            view.dispatch(\n              state.tr.setSelection(TextSelection.create(state.doc, pos)).scrollIntoView()\n            );\n\n            return true;\n          }\n          return false;\n        },\n    };\n  },\n\n  addProseMirrorPlugins() {\n    let previousAnchors: string[] = [];\n    return [\n      // Plugin to auto-generate unique anchors\n      new Plugin({\n        key: new PluginKey(\"autoOutlinePlugin\"),\n        appendTransaction: (transactions, oldState, newState) => {\n          let tr = newState.tr;\n          let modified = false;\n          const anchorsSeen = new Set<string>();\n\n          newState.doc.descendants((node, pos) => {\n            if (node.type.name === this.name) {\n              let anchor = node.attrs.anchor;\n              if (!anchor || anchorsSeen.has(anchor)) {\n                // If no anchor or duplicate anchor, generate a new one\n                anchor = uuidv4();\n                tr = tr.setNodeMarkup(pos, undefined, {\n                  ...node.attrs,\n                  anchor,\n                });\n                modified = true;\n              }\n              anchorsSeen.add(anchor);\n            }\n          });\n\n          if (modified) {\n            return tr;\n          }\n        },\n      }),\n      // Plugin to handle anchor updates\n      new Plugin({\n        key: new PluginKey(\"outlineUpdatePlugin\"),\n        view: () => {\n          return {\n            update: (view, prevState) => {\n              const { state } = view;\n              if (prevState.doc.eq(state.doc)) {\n                return;\n              }\n              const anchors: string[] = [];\n              state.doc.descendants((node) => {\n                if (node.type.name === this.name && node.attrs.anchor) {\n                  anchors.push(node.attrs.anchor);\n                }\n              });\n              if (JSON.stringify(anchors) !== JSON.stringify(previousAnchors)) {\n                previousAnchors = anchors;\n                if (this.options.onUpdate) {\n                  this.options.onUpdate(anchors);\n                }\n              }\n            },\n          };\n        },\n      }),\n    ];\n  },\n});\n"],"names":["uuidv4"],"mappings":"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"}